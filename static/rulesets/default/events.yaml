---
- id: Init
  trigger: Initialization
  once: true
  actions:
  - id: UpdateVariables
    updates:
      # number of papers read by the player
      player.readPapers: 0
      player.rulesBroken: 0
      player.canAttendConf: 0
      player.qualifyLevel: 0
  - id: SetStatus
    statusId: firstYear
    on: true
- id: LostAllHope
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: player.hope <= 0
  actions:
  - id: EndGame
    message: message.lostAllHope
    confirm: message.restart
    winning: false
- id: Graduated
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: itemCount('paper') >= 3
  actions:
  - id: EndGame
    message: message.graduated
    confirm: message.restart
    winning: true
- id: TheBeginning
  trigger: MonthBegin
  once: true
  actions:
  - id: DisplayMessage
    message: message.beginning
    confirm: message.excited
  - id: DisplayMessage
    message: message.qualifyNotice
    confirm: message.ok
- id: HopeUpdate
  trigger: MonthBegin
  actions:
  - id: UpdateVariable
    variable: player.hope
    value: player.hope + calcEffectValue('player.hopeBoost', 0)
# equipment event
- id: EquipmentBroken
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: "!hasStatus('brokenEquipment')"
  probability: 0.03
  exclusions:
  - EquipmentRepaired
  actions:
  - id: DisplayChoices
    message: message.equipmentBroken
    choices:
    - message: message.doNothing
      actions:
      - id: DisplayMessage
        message: message.cannotUseEquipment
        confirm: message.ok
      - id: UpdateVariables
        updates:
          player.hope: player.hope - 5
      - id: SetStatus
        statusId: brokenEquipment
        on: true
    - message: message.fixEquipment
      actions:
      - id: Random
        groups:
        - weight: 0.4
          actions:
          - id: DisplayMessage
            message: message.equipmentFixed
            confirm: message.great
          - id: UpdateVariable
            variable: player.hope
            value: player.hope + 2
        - weight: 0.6
          actions:
          - id: DisplayMessage
            message: message.equipmentNotFixed
            confirm: message.unfortunate
          - id: SetStatus
            statusId: brokenEquipment
            on: true
- id: EquipmentUpgrade
  trigger: MonthBegin
  once: true
  probability: 0.08
  conditions:
  - id: Expression
    expression: year >= 2
  actions:
  - id: DisplayMessage
    message: message.newEquipment
    confirm: message.cool
  - id: SetStatus
    statusId: upgradedEquipment
    on: true
  # the upgrade also fixes broken equipment
  - id: SetStatus
    statusId: brokenEquipment
    on: false
# qualify
- id: Qualify
  trigger: MonthBegin
  once: true
  conditions:
  - id: Expression
    expression: month === 12
  actions:
  - id: CoinFlip
    probability: player.qualifyLevel * 0.25
    success:
    - id: DisplayMessage
      message: message.qualifyPassed
      confirm: message.great
    fail:
    - id: EndGame
      winning: false
      message: message.qualifyFailed
      confirm: message.restart
# idea -> prelim -> major -> 2 figures -> submitted paper
- id: MonthBeginTasks
  trigger: MonthBegin
  actions:
  - id: DisplayChoices
    message: message.newMonth
    choices:
    - message: message.prepareQualify
      requirement: year === 1 && month < 12
      actions:
      - id: DisplayMessage
        message: message.qualifyLevelUp
        confirm: message.great
      - id: UpdateVariable
        variable: player.qualifyLevel
        value: player.qualifyLevel + 1
    - message: message.readPapers
      actions:
      - id: UpdateVariable
        variable: player.readPapers
        value: player.readPapers + 1
      - id: CoinFlip
        # increase the success rate as the player reads more papers
        probability: 0.70 + player.readPapers / 100 - itemCount('idea') / 20
        success:
        - id: GiveItem
          itemId: idea
          amount: 1
        - id: DisplayRandomMessage
          messages:
          - message.gainNewIdea1
          - message.gainNewIdea2
          confirm: message.great
        # possibly a good idea
        - id: CoinFlip
          probability: 0.2
          success:
          - id: DisplayMessage
            message: message.goodIdea
            confirm: message.encouraging
          - id: UpdateVariables
            updates:
              player.hope: player.hope + 2
        fail:
        - id: DisplayRandomMessage
          messages:
          - message.oldIdea1
          - message.oldIdea2
          - message.oldIdea3
          - message.oldIdea4
          confirm: message.oops
        - id: UpdateVariable
          variable: player.hope
          value: player.hope - 5
    - message: message.workOnIdea
      requirement: itemCount('idea') > 0
      actions:
      - id: GiveItem
        itemId: idea
        amount: -1
      - id: Random
        groups:
        - weight: 0.8
          actions:
          - id: DisplayMessage
            message: message.gainPrelimResult
            confirm: message.soundsInteresting
          - id: GiveItem
            itemId: preliminaryResult
            amount: 1
          - id: UpdateVariable
            variable: player.hope
            value: player.hope + 2
        - weight: 0.2
          actions:
          - id: DisplayMessage
            message: message.ideaNotWorking
            confirm: message.unfortunate
          - id: UpdateVariable
            variable: player.hope
            value: player.hope - 6
    - message: message.workOnPrelimResult
      requirement: itemCount('preliminaryResult') > 0
      actions:
      - id: Random
        groups:
        - weight: 0.7
          actions:
          - id: DisplayMessage
            message: message.gainMajorResult
            confirm: message.soundsInteresting
          - id: UpdateItemAmounts
            updates:
              majorResult: 1
              preliminaryResult: -1
          - id: UpdateVariable
            variable: player.hope
            value: player.hope + 2
        - weight: 0.3
          actions:
          - id: DisplayMessage
            message: message.noMajorResult
            confirm: message.unfortunate
          - id: UpdateVariable
            variable: player.hope
            value: player.hope - 8
    - message: message.workOnConf
      requirement: hasStatus('callForPapers') && itemCount('majorResult') > 0 && itemCount('submittedConfPaper') === 0
      actions:
      - id: DisplayMessage
        message: message.finishedConfPaper
        confirm: message.great
      - id: UpdateItemAmounts
        updates:
          submittedConfPaper: 1
          majorResult: -1
    - message: message.workOnFigure
      requirement: itemCount('majorResult') > 0 && itemCount('figure') < 2 * itemCount('majorResult') && !hasStatus('brokenEquipment')
      actions:
      - id: Random
        groups:
        - weight: 0.5 + calcEffectValue('player.experimentBoost', 0)
          actions:
          - id: DisplayMessage
            message: message.gainFigure
            confirm: message.great
          - id: GiveItem
            itemId: figure
            amount: 1
          - id: UpdateVariable
            variable: player.hope
            value: player.hope + 3
        - weight: 0.4
          actions:
          - id: DisplayRandomMessage
            messages:
            - message.noFigure1
            - message.noFigure2
            confirm: message.ok
          - id: UpdateVariable
            variable: player.hope
            value: player.hope - 3
        - weight: 0.1
          actions:
          - id: DisplayMessage
            message: message.wrongFigure
            confirm: message.unfortunate
          - id: UpdateItemAmounts
            updates:
              majorResult: -1
              preliminaryResult: 1
          - id: UpdateVariable
            variable: player.hope
            value: player.hope - 5
    - message: message.workOnPaper
      requirement: itemCount('majorResult') > 0 && itemCount('figure') > 1
      actions:
      - id: DisplayMessage
        message: message.draftPaperComplete
        confirm: message.great
      - id: UpdateItemAmounts
        updates:
          submittedPaper: 1
          majorResult: -1
          figure: -2
      - id: UpdateVariable
        variable: player.hope
        value: player.hope + 3
    - message: message.revisePaper
      requirement: itemCount('rejectedPaper') > 0
      actions:
      - id: DisplayMessage
        message: message.revisionComplete
        confirm: message.hopeAccepted
      - id: UpdateItemAmounts
        updates:
          resubmittedPaper: 1
          rejectedPaper: -1
    - message: message.slackOff
      actions:
      - id: Random
        groups:
        - weight: 1
          actions:
          - id: DisplayRandomMessage
            messages:
            - message.caughtSlackOff1
            - message.caughtSlackOff2
            confirm: message.oops
          - id: UpdateVariables
            updates:
              player.hope: player.hope - 10
              player.rulesBroken: player.rulesBroken + 1
        - weight: 2
          actions:
          - id: DisplayMessage
            message: message.slackOffSuccess
            confirm: message.great
          - id: UpdateVariable
            variable: player.hope
            value: player.hope + 5
# review events
# submitted -> accept
#           -> reject -> resubmit -> accept
#                                 -> reject -> lost figures
- id: PaperReview
  trigger: MonthBegin
  probability: 0.8
  conditions:
  - id: Expression
    expression: itemCount('submittedPaper') >= 1
  actions:
  - id: CoinFlip
    probability: calcEffectValue('player.paperAcceptanceBoost', 0) + 0.33
    success:
    - id: DisplayMessage
      message: message.paperAccepted
      confirm: message.party
    - id: UpdateItemAmounts
      updates:
        submittedPaper: -1
        paper: 1
    - id: UpdateVariable
      variable: player.hope
      value: player.hope + 10
    fail:
    - id: DisplayMessage
      message: message.paperRejected
      confirm: message.unfortunate
    - id: UpdateItemAmounts
      updates:
        submittedPaper: -1
        rejectedPaper: 1
    - id: UpdateVariable
      variable: player.hope
      value: player.hope - 10
- id: ResubmittedPaperReview
  trigger: MonthBegin
  probability: 0.8
  conditions:
  - id: Expression
    expression: itemCount('resubmittedPaper') >= 1
  actions:
  - id: CoinFlip
    probability: calcEffectValue('player.paperAcceptanceBoost', 0) + 0.5
    success:
    - id: DisplayMessage
      message: message.resubmittedPaperAccepted
      confirm: message.party
    - id: UpdateItemAmounts
      updates:
        resubmittedPaper: -1
        paper: 1
    - id: UpdateVariable
      variable: player.hope
      value: player.hope + 10
    fail:
    - id: DisplayMessage
      message: message.resubmittedPaperRejected
      confirm: message.unfortunate
    - id: UpdateItemAmounts
      updates:
        resubmittedPaper: -1
        majorResult: 1
    - id: UpdateVariable
      variable: player.hope
      value: player.hope - 20
# progress lost events
- id: IdeaDoneByOthers
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: itemCount('idea') >= 1
  probability: max(0.01, 0.07 - itemCount('conferencePaper') / 50)
  actions:
  - id: DisplayMessage
    message: message.ideaDoneByOthers
    confirm: message.unfortunate
  - id: GiveItem
    itemId: idea
    amount: -1
  - id: UpdateVariable
    variable: player.hope
    value: player.hope - 5
- id: PrelimDoneByOthers
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: itemCount('preliminaryResult') >= 1
  probability: 0.04
  actions:
  - id: DisplayMessage
    message: message.prelimDoneByOthers
    confirm: message.unfortunate
  - id: GiveItem
    itemId: preliminaryResult
    amount: -1
  - id: UpdateVariable
    variable: player.hope
    value: player.hope - 6
- id: FigureInvalid
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: itemCount('figure') >= 2
  actions:
  - id: CoinFlip
    probability: clip(0.1 - itemCount('paper') / 30, 0, 1)
    success:
    - id: DisplayMessage
      message: message.figureInvalid
      confirm: message.oops
    - id: GiveItem
      itemId: figure
      amount: -1
    - id: UpdateVariable
      variable: player.hope
      value: player.hope - 5
# progress advancement events
- id: Seminar
  trigger: MonthBegin
  probability: 0.05
  actions:
  - id: DisplayRandomMessage
    messages:
    - message.seminar1
    - message.seminar2
    confirm: message.soundsInteresting
  - id: GiveItem
    itemId: idea
    amount: 1
- id: ShowerIdea
  trigger: MonthBegin
  probability: 0.03
  conditions:
  - id: Expression
    expression: itemCount('preliminaryResult') >= 1
  actions:
  - id: DisplayMessage
    message: message.showerIdea
    confirm: message.cool
  - id: UpdateItemAmounts
    updates:
      preliminaryResult: -1
      majorResult: 1
# conference event chain
# 4 - 9 call for papers, 10-11 review 12 conf
- id: CallForPapers
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: month === 3
  actions:
  - id: DisplayMessage
    message: message.callForPapers
    confirm: message.cool
  - id: SetStatus
    statusId: callForPapers
    on: true
- id: ConfPaperReview
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: month === 11 && itemCount('submittedConfPaper') > 0
  actions:
  - id: CoinFlip
    probability: 0.4 + player.readPapers / 50
    success:
    - id: DisplayRandomMessage
      messages:
      - message.confPaperAccepted1
      - message.confPaperAccepted2
      confirm: message.great
    - id: UpdateVariables
      updates:
        player.hope: player.hope + 5
        player.canAttendConf: 1
    - id: UpdateItemAmounts
      updates:
        conferencePaper: 1
        submittedConfPaper: -1
    fail:
    - id: DisplayMessage
      message: message.confPaperRejected
      confirm: message.unfortunate
    - id: UpdateVariables
      updates:
        player.hope: player.hope - 10
    - id: UpdateItemAmounts
      updates:
        submittedConfPaper: -1
        majorResult: 1
- id: ConfMeeting
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: month === 12 && player.canAttendConf
  actions:
  - id: DisplayMessage
    message: message.attendConf
    confirm: message.cool
  - id: UpdateVariables
    updates:
      player.hope: player.hope + 5
      player.canAttendConf: 0
  - id: CoinFlip
    probability: 0.6
    success:
    - id: DisplayMessage
      message: message.confNewIdea
      confirm: message.great
    - id: GiveItem
      itemId: idea
      amount: 1
# random events
- id: PaperCitation
  trigger: MonthBegin
  conditions:
  - id: Expression
    expression: itemCount('paper') >= 1 || itemCount('conferencePaper') >= 1
  probability: 0.1
  actions:
  - id: DisplayMessage
    message: message.paperCited
    confirm: message.great
  - id: UpdateVariable
    variable: player.hope
    value: player.hope + 5
- id: EmergencyHope
  trigger: MonthBegin
  probability: 0.1
  conditions:
  - id: Expression
    expression: player.hope < 20 && month >= 3 && month <= 8
  actions:
  - id: DisplayRandomMessage
    messages:
    - message.randomHope1
    - message.randomHope2
    - message.randomHope3
    - message.randomHope4
    - message.randomHope5
    confirm: message.hope
  - id: UpdateVariable
    variable: player.hope
    value: player.hope + 5


